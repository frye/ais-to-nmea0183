name: Release Build

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-release:
    name: Build Release Artifacts
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            runtime: linux-x64
            artifact-name: ais-to-n2k-linux-x64
          - os: windows-latest
            runtime: win-x64
            artifact-name: ais-to-n2k-windows-x64
          - os: macos-latest
            runtime: osx-x64
            artifact-name: ais-to-n2k-macos-x64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Run tests
      run: dotnet test --configuration Release --filter "Category!=LongRunning"
      
    - name: Publish self-contained
      run: |
        dotnet publish AisToN2K/AisToN2K.csproj \
          --configuration Release \
          --runtime ${{ matrix.runtime }} \
          --self-contained true \
          --output ./publish/${{ matrix.runtime }} \
          -p:PublishSingleFile=true \
          -p:PublishTrimmed=true
          
    - name: Create release package
      run: |
        mkdir -p ./release-packages
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          7z a ./release-packages/${{ matrix.artifact-name }}.zip ./publish/${{ matrix.runtime }}/*
        else
          tar -czf ./release-packages/${{ matrix.artifact-name }}.tar.gz -C ./publish/${{ matrix.runtime }} .
        fi
      shell: bash
      
    - name: Upload release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: release-packages/
        retention-days: 90
        compression-level: 9

  create-release-summary:
    name: Create Release Summary
    runs-on: ubuntu-latest
    needs: build-release
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./all-artifacts
        
    - name: Create release summary
      run: |
        echo "# ðŸš¢ AIS to NMEA 0183 Converter Release" >> release-summary.md
        echo "" >> release-summary.md
        echo "## ðŸ“¦ Release Artifacts" >> release-summary.md
        echo "" >> release-summary.md
        echo "| Platform | Runtime | Artifact |" >> release-summary.md
        echo "|----------|---------|----------|" >> release-summary.md
        
        for dir in ./all-artifacts/*/; do
          if [ -d "$dir" ]; then
            artifact_name=$(basename "$dir")
            files=$(ls "$dir" 2>/dev/null || echo "No files")
            echo "| $artifact_name | - | $files |" >> release-summary.md
          fi
        done
        
        echo "" >> release-summary.md
        echo "## ðŸ” Quick Start" >> release-summary.md
        echo "" >> release-summary.md
        echo "1. Download the appropriate artifact for your platform" >> release-summary.md
        echo "2. Extract the archive" >> release-summary.md
        echo "3. Run the executable with \`--help\` to see usage options" >> release-summary.md
        echo "4. Configure your API key using the setup scripts" >> release-summary.md
        
        cat release-summary.md
        
    - name: Upload release summary
      uses: actions/upload-artifact@v4
      with:
        name: release-summary
        path: release-summary.md
        retention-days: 90
